<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini CMS Supabase</title>

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#0073e6; color:white; padding:1rem; text-align:center; }
main { padding:2rem; max-width:900px; margin:auto; }
h2 { border-bottom:2px solid #0073e6; padding-bottom:0.5rem; }
.notizia { background:white; padding:1rem; margin-bottom:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:relative; }
.notizia img { max-width:100%; border-radius:5px; margin-top:0.5rem; }
.btn { cursor:pointer; padding:0.3rem 0.6rem; margin-left:0.5rem; border:none; border-radius:4px; }
.btn-edit { background:#ffc107; color:white; }
.btn-delete { background:#dc3545; color:white; }
form { background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:2rem; }
form input, form button { width:100%; margin-bottom:0.5rem; padding:0.5rem; }
#editor { height:150px; background:white; }
.flex { display:flex; align-items:center; }
</style>
</head>
<body>

<header>
<h1>Mini CMS Supabase</h1>
</header>

<main>
<section>
<h2>Aggiungi / Modifica Notizia</h2>
<form id="formNotizia">
  <input type="hidden" id="indiceNotizia">
  <input type="text" id="titolo" placeholder="Titolo" required>
  <input type="date" id="data" required>
  <input type="url" id="immagine" placeholder="URL immagine (opzionale)">
  <div id="editor"></div>
  <button type="submit" id="btnSalva">Salva Notizia</button>
</form>
</section>

<section>
<h2>Notizie e Avvisi</h2>
<div id="notizie">Caricamento notizie...</div>
</section>
</main>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://mvcfmmmkfxzgmmqbgbnf.supabase.co";
const supabaseKey = "LA_TUA_ANON_PUBLIC_KEY"; // sostituisci con la tua anon key
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Inizializza Quill
const quill = new Quill('#editor', { theme: 'snow' });

const form = document.getElementById('formNotizia');
const btnSalva = document.getElementById('btnSalva');
const indiceInput = document.getElementById('indiceNotizia');

async function caricaNotizie() {
  const { data, error } = await supabase
    .from("notizie")
    .select("*")
    .order("data", { ascending: false });

  const container = document.getElementById("notizie");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = "<p>Errore nel caricamento delle notizie.</p>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    container.innerHTML = "<p>Nessuna notizia disponibile.</p>";
    return;
  }

  data.forEach(n => {
    const div = document.createElement('div');
    div.className = 'notizia';
    div.innerHTML = `
      <div class="flex">
        <h3 style="flex:1">${n.titolo}</h3>
        <button class="btn btn-edit" onclick="modificaNotizia('${n.id}')">Modifica</button>
        <button class="btn btn-delete" onclick="eliminaNotizia('${n.id}')">Elimina</button>
      </div>
      <small>${n.data}</small>
      ${n.immagine ? `<img src="${n.immagine}" alt="${n.titolo}">` : ''}
      <div>${n.contenuto}</div>
    `;
    container.appendChild(div);
  });
}

form.addEventListener('submit', async e => {
  e.preventDefault();

  const nuova = {
    titolo: document.getElementById('titolo').value,
    data: document.getElementById('data').value,
    immagine: document.getElementById('immagine').value,
    contenuto: quill.root.innerHTML
  };

  if (indiceInput.value) {
    // modifica
    await supabase.from('notizie')
      .update(nuova)
      .eq('id', indiceInput.value);
    indiceInput.value = '';
    btnSalva.textContent = 'Salva Notizia';
  } else {
    // inserimento
    await supabase.from('notizie')
      .insert([nuova]);
  }

  form.reset();
  quill.setContents([]);
  caricaNotizie();
});

window.modificaNotizia = async function(id) {
  const { data } = await supabase
    .from('notizie')
    .select('*')
    .eq('id', id)
    .single();

  document.getElementById('titolo').value = data.titolo;
  document.getElementById('data').value = data.data;
  document.getElementById('immagine').value = data.immagine;
  quill.root.innerHTML = data.contenuto;
  indiceInput.value = data.id;
  btnSalva.textContent = 'Aggiorna Notizia';
  window.scrollTo({top:0, behavior:'smooth'});
}

window.eliminaNotizia = async function(id) {
  if (!confirm('Sei sicuro di voler eliminare questa notizia?')) return;

  await supabase.from('notizie')
    .delete()
    .eq('id', id);

  caricaNotizie();
}

// Carica allâ€™avvio
caricaNotizie();
</script>

</body>
</html>
